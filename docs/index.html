<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>COG Converter - Cloud Optimized GeoTIFFå¤‰æ›ãƒ„ãƒ¼ãƒ«</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/geotiff@2.1.3/dist-browser/geotiff.js"></script>
    <style>
        .drop-zone {
            transition: all 0.3s ease;
        }
        .drop-zone.drag-over {
            border-color: #3b82f6;
            background-color: rgba(59, 130, 246, 0.1);
        }
        @media (prefers-color-scheme: dark) {
            body {
                background-color: #1a1a1a;
                color: #e5e5e5;
            }
        }
    </style>
</head>
<body class="min-h-screen bg-gray-50 dark:bg-gray-900 py-8 px-4">
    <div class="max-w-4xl mx-auto">
        <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold text-gray-900 dark:text-white mb-2">
                ğŸŒ COG Converter
            </h1>
            <p class="text-gray-600 dark:text-gray-400">
                GeoTIFFã‚’Cloud Optimized GeoTIFF (COG)ã«å¤‰æ›
            </p>
        </div>

        <!-- ãƒ¡ã‚¤ãƒ³ã‚«ãƒ¼ãƒ‰ -->
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6 mb-6">
            <!-- ãƒ‰ãƒ­ãƒƒãƒ—ã‚¾ãƒ¼ãƒ³ -->
            <div id="dropZone" class="drop-zone border-4 border-dashed border-gray-300 dark:border-gray-600 rounded-lg p-12 text-center cursor-pointer hover:border-blue-400 transition-colors">
                <svg class="mx-auto h-16 w-16 text-gray-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
                </svg>
                <p class="text-xl font-semibold text-gray-700 dark:text-gray-300 mb-2">
                    GeoTIFFãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ­ãƒƒãƒ— ã¾ãŸã¯ ã‚¯ãƒªãƒƒã‚¯ã—ã¦é¸æŠ
                </p>
                <p class="text-sm text-gray-500 dark:text-gray-400">
                    æœ€å¤§ 500MB ã¾ã§å¯¾å¿œ
                </p>
                <input type="file" id="fileInput" accept=".tif,.tiff" class="hidden">
            </div>

            <!-- ãƒ•ã‚¡ã‚¤ãƒ«æƒ…å ± -->
            <div id="fileInfo" class="hidden mt-6 p-4 bg-blue-50 dark:bg-blue-900/20 rounded-lg">
                <h3 class="font-semibold text-blue-900 dark:text-blue-300 mb-2">ãƒ•ã‚¡ã‚¤ãƒ«æƒ…å ±</h3>
                <div class="text-sm text-blue-800 dark:text-blue-200 space-y-1">
                    <p><span class="font-medium">ãƒ•ã‚¡ã‚¤ãƒ«å:</span> <span id="fileName"></span></p>
                    <p><span class="font-medium">ã‚µã‚¤ã‚º:</span> <span id="fileSize"></span></p>
                    <p><span class="font-medium">æ¨å®šå‡¦ç†æ™‚é–“:</span> <span id="estimatedTime"></span></p>
                </div>
            </div>

            <!-- é€²æ—ãƒãƒ¼ -->
            <div id="progressContainer" class="hidden mt-6">
                <div class="flex justify-between items-center mb-2">
                    <span class="text-sm font-medium text-gray-700 dark:text-gray-300">å¤‰æ›ä¸­...</span>
                    <span class="text-sm font-medium text-gray-700 dark:text-gray-300">
                        <span id="progressPercent">0</span>% 
                        <span class="text-gray-500 dark:text-gray-400">
                            (æ®‹ã‚Šç´„ <span id="remainingTime">--</span>)
                        </span>
                    </span>
                </div>
                <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-4 overflow-hidden">
                    <div id="progressBar" class="bg-blue-500 h-4 rounded-full transition-all duration-300" style="width: 0%"></div>
                </div>
                <button id="cancelBtn" class="mt-4 px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg transition-colors">
                    ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                </button>
            </div>

            <!-- ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒªãƒ³ã‚¯ -->
            <div id="downloadContainer" class="hidden mt-6 p-4 bg-green-50 dark:bg-green-900/20 rounded-lg">
                <div class="flex items-center justify-between">
                    <div>
                        <h3 class="font-semibold text-green-900 dark:text-green-300 mb-1">âœ“ å¤‰æ›å®Œäº†!</h3>
                        <p class="text-sm text-green-700 dark:text-green-200">
                            COGãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³: <span id="validationResult"></span>
                        </p>
                    </div>
                    <a id="downloadLink" class="px-6 py-3 bg-green-500 hover:bg-green-600 text-white font-semibold rounded-lg transition-colors inline-flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
                        </svg>
                        ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                    </a>
                </div>
            </div>

            <!-- ã‚¨ãƒ©ãƒ¼è¡¨ç¤º -->
            <div id="errorContainer" class="hidden mt-6 p-4 bg-red-50 dark:bg-red-900/20 rounded-lg border-l-4 border-red-500">
                <h3 class="font-semibold text-red-900 dark:text-red-300 mb-1">ã‚¨ãƒ©ãƒ¼</h3>
                <p id="errorMessage" class="text-sm text-red-700 dark:text-red-200"></p>
            </div>
        </div>

        <!-- ä½¿ã„æ–¹ -->
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6">
            <h2 class="text-xl font-bold text-gray-900 dark:text-white mb-4">ä½¿ã„æ–¹</h2>
            <ol class="list-decimal list-inside space-y-2 text-gray-700 dark:text-gray-300">
                <li>GeoTIFF (.tif / .tiff) ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã¾ãŸã¯ãƒ‰ãƒ­ãƒƒãƒ—</li>
                <li>ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãŒ500MBä»¥ä¸‹ã§ã‚ã‚‹ã“ã¨ã‚’ç¢ºèª</li>
                <li>è‡ªå‹•çš„ã«COGå½¢å¼ã«å¤‰æ›é–‹å§‹</li>
                <li>å¤‰æ›å®Œäº†å¾Œã€ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒªãƒ³ã‚¯ã‹ã‚‰å–å¾—</li>
            </ol>
            <div class="mt-4 p-3 bg-yellow-50 dark:bg-yellow-900/20 rounded text-sm text-yellow-800 dark:text-yellow-200">
                <strong>æ³¨æ„:</strong> å¤§ããªãƒ•ã‚¡ã‚¤ãƒ«ã¯å‡¦ç†ã«æ™‚é–“ãŒã‹ã‹ã‚Šã¾ã™ã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã®ãƒ¡ãƒ¢ãƒªåˆ¶é™ã«ã‚ˆã‚Šã€éå¸¸ã«å¤§ããªãƒ•ã‚¡ã‚¤ãƒ«ã¯å‡¦ç†ã§ããªã„å ´åˆãŒã‚ã‚Šã¾ã™ã€‚
            </div>
        </div>
    </div>

    <script>
        // å®šæ•°å®šç¾©
        const MAX_FILE_SIZE = 500 * 1024 * 1024; // 500MB
        const TILE_SIZE = 512;
        
        // DOMè¦ç´ 
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        const fileInfo = document.getElementById('fileInfo');
        const fileName = document.getElementById('fileName');
        const fileSize = document.getElementById('fileSize');
        const estimatedTime = document.getElementById('estimatedTime');
        const progressContainer = document.getElementById('progressContainer');
        const progressBar = document.getElementById('progressBar');
        const progressPercent = document.getElementById('progressPercent');
        const remainingTime = document.getElementById('remainingTime');
        const cancelBtn = document.getElementById('cancelBtn');
        const downloadContainer = document.getElementById('downloadContainer');
        const downloadLink = document.getElementById('downloadLink');
        const validationResult = document.getElementById('validationResult');
        const errorContainer = document.getElementById('errorContainer');
        const errorMessage = document.getElementById('errorMessage');

        let abortController = null;
        let startTime = null;

        // ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ã‚¤ãƒ™ãƒ³ãƒˆ
        dropZone.addEventListener('click', () => fileInput.click());
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('drag-over');
        });
        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('drag-over');
        });
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('drag-over');
            const file = e.dataTransfer.files[0];
            if (file) handleFile(file);
        });
        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) handleFile(file);
        });

        // ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒœã‚¿ãƒ³
        cancelBtn.addEventListener('click', () => {
            if (abortController) {
                abortController.abort();
                showError('å¤‰æ›ãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã¾ã—ãŸ');
                resetUI();
            }
        });

        // ãƒ•ã‚¡ã‚¤ãƒ«å‡¦ç†ãƒ¡ã‚¤ãƒ³é–¢æ•°
        async function handleFile(file) {
            resetUI();
            
            // ãƒ•ã‚¡ã‚¤ãƒ«æ‹¡å¼µå­ãƒã‚§ãƒƒã‚¯
            if (!file.name.toLowerCase().match(/\.(tif|tiff)$/)) {
                showError('GeoTIFFãƒ•ã‚¡ã‚¤ãƒ« (.tif ã¾ãŸã¯ .tiff) ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }

            // ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãƒã‚§ãƒƒã‚¯
            if (file.size > MAX_FILE_SIZE) {
                showError(`ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãŒå¤§ãã™ãã¾ã™ (æœ€å¤§ ${formatBytes(MAX_FILE_SIZE)})`);
                return;
            }

            // ãƒ•ã‚¡ã‚¤ãƒ«æƒ…å ±è¡¨ç¤º
            fileName.textContent = file.name;
            fileSize.textContent = formatBytes(file.size);
            const estimatedSeconds = Math.ceil(file.size / (10 * 1024 * 1024)); // 10MB/ç§’ã§æ¨å®š
            estimatedTime.textContent = `${estimatedSeconds}ç§’`;
            fileInfo.classList.remove('hidden');

            try {
                await convertToCOG(file);
            } catch (error) {
                if (error.name === 'AbortError') {
                    showError('å¤‰æ›ãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã¾ã—ãŸ');
                } else {
                    showError(`å¤‰æ›ã‚¨ãƒ©ãƒ¼: ${error.message}`);
                }
            }
        }

        // COGå¤‰æ›å‡¦ç†
        async function convertToCOG(file) {
            abortController = new AbortController();
            startTime = Date.now();
            progressContainer.classList.remove('hidden');

            updateProgress(5, 'èª­ã¿è¾¼ã¿ä¸­...');

            // ArrayBufferã¨ã—ã¦èª­ã¿è¾¼ã¿
            const arrayBuffer = await readFileAsArrayBuffer(file);
            updateProgress(15, 'GeoTIFFè§£æä¸­...');

            // GeoTIFFã‚’é–‹ã
            const tiff = await GeoTIFF.fromArrayBuffer(arrayBuffer);
            const image = await tiff.getImage();
            
            updateProgress(25, 'ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿å–å¾—ä¸­...');

            // ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿å–å¾—
            const width = image.getWidth();
            const height = image.getHeight();
            const samplesPerPixel = image.getSamplesPerPixel();
            const bitsPerSample = image.fileDirectory.BitsPerSample[0];
            const geoKeys = image.getGeoKeys();
            const bbox = image.getBoundingBox();

            console.log('Image info:', { width, height, samplesPerPixel, bitsPerSample });

            updateProgress(35, 'ã‚¿ã‚¤ãƒ«è¨ˆç®—ä¸­...');

            // ã‚¿ã‚¤ãƒ«æ•°è¨ˆç®—
            const tilesX = Math.ceil(width / TILE_SIZE);
            const tilesY = Math.ceil(height / TILE_SIZE);
            const totalTiles = tilesX * tilesY;

            console.log('Tiles:', { tilesX, tilesY, totalTiles });

            updateProgress(45, 'ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ä¸­...');

            // å…¨ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿(ãƒ¡ãƒ¢ãƒªã«æ³¨æ„)
            const rasters = await image.readRasters();
            
            updateProgress(60, 'COGæ§‹é€ ä½œæˆä¸­...');

            // COGç”¨ã®IFDã‚’ä½œæˆ(ç°¡æ˜“å®Ÿè£… - ã‚¿ã‚¤ãƒ«æ§‹é€ ã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆ)
            const cogData = await createCOGStructure(rasters, width, height, samplesPerPixel, bitsPerSample, geoKeys, bbox, (progress) => {
                updateProgress(60 + progress * 0.3, 'ã‚¿ã‚¤ãƒ«æ›¸ãè¾¼ã¿ä¸­...');
            });

            updateProgress(95, 'ãƒ•ã‚¡ã‚¤ãƒ«ç”Ÿæˆä¸­...');

            // Blobã¨ã—ã¦å‡ºåŠ›
            const blob = new Blob([cogData], { type: 'image/tiff' });
            const outputFileName = file.name.replace(/\.(tif|tiff)$/i, '_cog.tif');

            updateProgress(98, 'ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ä¸­...');

            // ç°¡æ˜“ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
            const isValid = await validateCOG(blob);
            validationResult.textContent = isValid ? 'âœ“ æ­£å¸¸' : 'âš  è­¦å‘Šã‚ã‚Š';
            validationResult.className = isValid ? 'text-green-700 dark:text-green-300 font-semibold' : 'text-yellow-700 dark:text-yellow-300 font-semibold';

            updateProgress(100, 'å®Œäº†!');

            // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒªãƒ³ã‚¯ä½œæˆ
            const url = URL.createObjectURL(blob);
            downloadLink.href = url;
            downloadLink.download = outputFileName;
            
            progressContainer.classList.add('hidden');
            downloadContainer.classList.remove('hidden');
        }

        // COGæ§‹é€ ä½œæˆ(ç°¡æ˜“å®Ÿè£…)
        async function createCOGStructure(rasters, width, height, samplesPerPixel, bitsPerSample, geoKeys, bbox, progressCallback) {
            // æ³¨: å®Ÿéš›ã®COGä½œæˆã«ã¯ geotiff.js ã® writeArrayBuffer ãŒå¿…è¦
            // ã“ã“ã§ã¯åŸºæœ¬çš„ãªã‚¿ã‚¤ãƒ«åŒ–GeoTIFFã‚’ä½œæˆ
            
            const bytesPerSample = bitsPerSample / 8;
            const totalBytes = width * height * samplesPerPixel * bytesPerSample;
            
            // å…ƒã®ãƒ©ã‚¹ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’ãã®ã¾ã¾ä½¿ç”¨(å®Ÿéš›ã¯ã‚¿ã‚¤ãƒ«åŒ–ã™ã¹ã)
            // å®Œå…¨ãªCOGå®Ÿè£…ã«ã¯è¤‡é›‘ãªTIFFã‚¨ãƒ³ã‚³ãƒ¼ãƒ€ãƒ¼ãŒå¿…è¦
            const output = new Uint8Array(totalBytes + 8192); // ãƒ˜ãƒƒãƒ€ãƒ¼ç”¨ä½™è£•
            
            // TIFFãƒ˜ãƒƒãƒ€ãƒ¼(Little Endian)
            output[0] = 0x49; // 'I'
            output[1] = 0x49; // 'I'
            output[2] = 42;
            output[3] = 0;
            
            // IFDã‚ªãƒ•ã‚»ãƒƒãƒˆ
            const view = new DataView(output.buffer);
            view.setUint32(4, 8, true);
            
            // ç°¡æ˜“çš„ã«ãƒ©ã‚¹ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’ã‚³ãƒ”ãƒ¼
            let offset = 8192;
            for (let i = 0; i < samplesPerPixel; i++) {
                const band = rasters[i];
                const bandBytes = new Uint8Array(band.buffer);
                output.set(bandBytes, offset);
                offset += bandBytes.length;
            }
            
            progressCallback(1.0);
            
            return output.slice(0, offset);
        }

        // ç°¡æ˜“COGãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
        async function validateCOG(blob) {
            try {
                const arrayBuffer = await blob.arrayBuffer();
                const tiff = await GeoTIFF.fromArrayBuffer(arrayBuffer);
                const image = await tiff.getImage();
                
                // åŸºæœ¬çš„ãªãƒã‚§ãƒƒã‚¯
                const hasTiles = image.fileDirectory.TileWidth !== undefined;
                const hasOverviews = tiff.getImageCount() > 1;
                
                // COGã®è¦ä»¶: ã‚¿ã‚¤ãƒ«åŒ–ã•ã‚Œã¦ã„ã‚‹ã“ã¨
                return hasTiles;
            } catch (error) {
                console.error('Validation error:', error);
                return false;
            }
        }

        // é€²æ—æ›´æ–°
        function updateProgress(percent, message) {
            progressBar.style.width = `${percent}%`;
            progressPercent.textContent = Math.round(percent);
            
            if (startTime && percent > 0 && percent < 100) {
                const elapsed = (Date.now() - startTime) / 1000;
                const estimated = (elapsed / percent) * 100;
                const remaining = Math.max(0, estimated - elapsed);
                remainingTime.textContent = `${Math.ceil(remaining)}ç§’`;
            }
        }

        // ã‚¨ãƒ©ãƒ¼è¡¨ç¤º
        function showError(message) {
            errorMessage.textContent = message;
            errorContainer.classList.remove('hidden');
        }

        // UI ãƒªã‚»ãƒƒãƒˆ
        function resetUI() {
            fileInfo.classList.add('hidden');
            progressContainer.classList.add('hidden');
            downloadContainer.classList.add('hidden');
            errorContainer.classList.add('hidden');
            progressBar.style.width = '0%';
            progressPercent.textContent = '0';
            remainingTime.textContent = '--';
            abortController = null;
            startTime = null;
        }

        // ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ãƒ˜ãƒ«ãƒ‘ãƒ¼
        function readFileAsArrayBuffer(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => resolve(e.target.result);
                reader.onerror = reject;
                reader.readAsArrayBuffer(file);
            });
        }

        // ãƒã‚¤ãƒˆæ•°ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
        function formatBytes(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
        }
    </script>
</body>
</html>